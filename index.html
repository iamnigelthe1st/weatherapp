<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Forecast Dashboard</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js CDN -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <style>
      /* Custom Animations */
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes float {
        from {
          transform: translateX(-10px);
        }
        to {
          transform: translateX(10px);
        }
      }

      @keyframes fall {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(20px);
          opacity: 1;
        }
      }

      @keyframes fall-slow {
        from {
          transform: translateY(-15px);
          opacity: 0;
        }
        to {
          transform: translateY(25px);
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .animate-spin-slow {
        animation: spin 20s linear infinite;
      }

      .animate-float {
        animation: float 6s ease-in-out infinite alternate;
      }

      .animate-fall {
        animation: fall 1s linear infinite;
      }

      .animate-fall-slow {
        animation: fall-slow 3s ease-in infinite;
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out;
      }

      .animate-pulse-custom {
        animation: pulse 1.5s ease-in-out infinite;
      }

      /* Font */
      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
      }
    </style>
  </head>
  <body
    class="min-h-screen transition-all duration-1000"
    x-data="weatherApp()"
    :class="bgClass"
  >
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <!-- Header Controls -->
      <header class="mb-8">
        <div
          class="flex flex-col md:flex-row gap-4 items-center justify-between bg-white/20 backdrop-blur-md rounded-2xl p-6 shadow-lg"
        >
          <!-- Search Bar -->
          <div class="flex gap-2 flex-1 w-full md:w-auto">
            <input
              type="text"
              x-model="searchQuery"
              @keyup.enter="searchCity"
              :disabled="loading"
              placeholder="Enter city name..."
              class="flex-1 px-4 py-2 rounded-lg border-2 border-white/30 bg-white/50 backdrop-blur-sm focus:outline-none focus:border-blue-400 transition-all"
            />
            <button
              @click="searchCity"
              :disabled="loading"
              aria-label="Search weather by city"
              class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-semibold shadow-md"
            >
              Search
            </button>
          </div>

          <!-- Geolocation Button -->
          <button
            @click="getCurrentLocation"
            :disabled="loading"
            aria-label="Use my current location"
            class="p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
            title="Use my location"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>

          <!-- Unit Toggle -->
          <div class="flex items-center gap-2 bg-white/30 rounded-lg p-1">
            <button
              @click="units = 'metric'"
              :class="units === 'metric' ? 'bg-white shadow-md' : 'bg-transparent'"
              class="px-4 py-2 rounded-md transition-all font-semibold"
            >
              °C
            </button>
            <button
              @click="units = 'imperial'"
              :class="units === 'imperial' ? 'bg-white shadow-md' : 'bg-transparent'"
              class="px-4 py-2 rounded-md transition-all font-semibold"
            >
              °F
            </button>
          </div>
        </div>

        <!-- Copyright -->
        <div class="mt-4 text-center text-white/80 text-sm">
          <p>Copyright © 2025 Keegan Kinyanjui</p>
        </div>
      </header>

      <!-- Error Message -->
      <div
        x-show="error"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        role="alert"
        aria-live="assertive"
        class="mb-6 p-4 bg-red-100 border-2 border-red-400 text-red-800 rounded-lg shadow-md"
      >
        <p class="font-semibold" x-text="error"></p>
      </div>

      <!-- Loading Skeleton -->
      <div x-show="loading" class="space-y-6">
        <div class="bg-white/20 backdrop-blur-md rounded-2xl p-8 shadow-lg">
          <div class="animate-pulse-custom space-y-4">
            <div class="h-8 bg-white/30 rounded w-1/3"></div>
            <div class="h-16 bg-white/30 rounded w-1/2"></div>
            <div class="grid grid-cols-3 gap-4">
              <div class="h-12 bg-white/30 rounded"></div>
              <div class="h-12 bg-white/30 rounded"></div>
              <div class="h-12 bg-white/30 rounded"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Weather Card -->
      <div
        x-show="currentWeather && !loading"
        x-transition:enter="transition ease-out duration-500"
        x-transition:enter-start="opacity-0 transform translate-y-4"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        class="mb-8 bg-white/20 backdrop-blur-md rounded-2xl p-8 shadow-xl"
      >
        <template x-if="currentWeather">
          <div>
            <!-- City Name and Country -->
            <div class="mb-4">
              <h1
                class="text-3xl md:text-4xl font-bold text-white"
                x-text="locationName"
              ></h1>
              <p class="text-white/80 text-lg" x-text="countryCode"></p>
            </div>

            <!-- Temperature and Icon -->
            <div class="flex items-center justify-between mb-6">
              <div>
                <div
                  class="text-5xl md:text-7xl font-extrabold text-white"
                  x-text="displayTemp(currentWeather.temperature_2m)"
                ></div>
                <p
                  class="text-xl md:text-2xl text-white/90 mt-2"
                  x-text="mapWeatherCode(currentWeather.weather_code).text"
                ></p>
              </div>

              <!-- Weather Icon -->
              <div
                class="w-24 h-24 md:w-32 md:h-32"
                x-html="getWeatherIcon(currentWeather.weather_code)"
              ></div>
            </div>

            <!-- Weather Details Grid -->
            <div class="grid grid-cols-3 gap-4">
              <div
                class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center"
              >
                <p class="text-white/70 text-sm mb-1">Humidity</p>
                <p
                  class="text-white text-xl font-semibold"
                  x-text="currentWeather.relative_humidity_2m + '%'"
                ></p>
              </div>
              <div
                class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center"
              >
                <p class="text-white/70 text-sm mb-1">Wind Speed</p>
                <p
                  class="text-white text-xl font-semibold"
                  x-text="displayWindSpeed(currentWeather.wind_speed_10m)"
                ></p>
              </div>
              <div
                class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center"
              >
                <p class="text-white/70 text-sm mb-1">Feels Like</p>
                <p
                  class="text-white text-xl font-semibold"
                  x-text="displayTemp(currentWeather.temperature_2m - 2)"
                ></p>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- 5-Day Forecast -->
      <div
        x-show="forecast.length > 0 && !loading"
        x-transition:enter="transition ease-out duration-500 delay-150"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
      >
        <h2 class="text-2xl md:text-3xl font-bold text-white mb-4">
          5-Day Forecast
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
          <template x-for="(day, index) in forecast" :key="index">
            <div
              class="bg-white/20 backdrop-blur-md rounded-xl p-6 text-center shadow-lg hover:shadow-xl transition-all animate-fade-in-up"
              :style="'animation-delay: ' + (index * 0.1) + 's'"
            >
              <p
                class="text-white font-semibold text-lg mb-3"
                x-text="formatDay(day.time)"
              ></p>
              <div
                class="w-16 h-16 mx-auto mb-3"
                x-html="getWeatherIcon(day.weather_code)"
              ></div>
              <div class="space-y-1">
                <p
                  class="text-white text-xl font-bold"
                  x-text="displayTemp(day.temperature_2m_max)"
                ></p>
                <p
                  class="text-white/70 text-sm"
                  x-text="displayTemp(day.temperature_2m_min)"
                ></p>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <script>
      function weatherApp() {
        return {
          // State properties
          searchQuery: "",
          currentWeather: null,
          forecast: [],
          loading: false,
          error: null,
          units: "metric",
          bgClass: "bg-gradient-to-br from-blue-400 to-blue-600",
          locationName: "",
          countryCode: "",

          // Search city
          async searchCity() {
            if (!this.searchQuery.trim()) {
              this.error = "Please enter a city name";
              return;
            }

            this.loading = true;
            this.error = null;

            try {
              // Step 1: Geocoding
              const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(
                this.searchQuery
              )}&count=1&language=en&format=json`;
              console.log("Fetching geocoding data from:", geoUrl);

              const geoResponse = await fetch(geoUrl);

              if (!geoResponse.ok) {
                throw new Error(
                  `Geocoding API returned status ${geoResponse.status}`
                );
              }

              const geoData = await geoResponse.json();
              console.log("Geocoding response:", geoData);

              if (!geoData.results || geoData.results.length === 0) {
                this.error = "Location not found, please try again";
                this.loading = false;
                return;
              }

              const location = geoData.results[0];
              await this.fetchWeatherByCoords(
                location.latitude,
                location.longitude,
                location.name,
                location.country_code || location.country
              );
            } catch (err) {
              console.error("Search error:", err);
              this.error =
                "Unable to connect. Check your internet connection. Error: " +
                err.message;
              this.loading = false;
            }
          },

          // Get current location
          async getCurrentLocation() {
            if (!navigator.geolocation) {
              this.error = "Geolocation is not supported by your browser";
              return;
            }

            this.loading = true;
            this.error = null;

            navigator.geolocation.getCurrentPosition(
              async (position) => {
                await this.fetchWeatherByCoords(
                  position.coords.latitude,
                  position.coords.longitude,
                  "Your Location",
                  ""
                );
              },
              (error) => {
                this.error = "Location access denied. Please search manually.";
                this.loading = false;
              }
            );
          },

          // Fetch weather by coordinates
          async fetchWeatherByCoords(lat, lon, name, country) {
            try {
              // Build URL with proper parameters - time is automatically included in daily
              const params = new URLSearchParams({
                latitude: lat,
                longitude: lon,
                current:
                  "temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m",
                daily: "weather_code,temperature_2m_max,temperature_2m_min",
                timezone: "auto",
              });
              const weatherUrl = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
              console.log("Fetching weather data from:", weatherUrl);

              const weatherResponse = await fetch(weatherUrl);

              if (!weatherResponse.ok) {
                throw new Error(
                  `Weather API returned status ${weatherResponse.status}`
                );
              }

              const weatherData = await weatherResponse.json();
              console.log("Weather response:", weatherData);

              if (!weatherData.current || !weatherData.daily) {
                console.error("Invalid weather data structure:", weatherData);
                this.error = "Unable to fetch weather data - invalid response";
                this.loading = false;
                return;
              }

              // Store data
              this.currentWeather = weatherData.current;
              this.locationName = name;
              this.countryCode = country;

              // Build 5-day forecast
              this.forecast = [];
              for (let i = 0; i < 5 && i < weatherData.daily.time.length; i++) {
                this.forecast.push({
                  time: weatherData.daily.time[i],
                  weather_code: weatherData.daily.weather_code[i],
                  temperature_2m_max: weatherData.daily.temperature_2m_max[i],
                  temperature_2m_min: weatherData.daily.temperature_2m_min[i],
                });
              }

              console.log("Current weather:", this.currentWeather);
              console.log("Forecast:", this.forecast);

              // Update background
              this.updateBackground(this.currentWeather.weather_code);

              this.loading = false;
            } catch (err) {
              console.error("Weather fetch error:", err);
              this.error = "Unable to fetch weather data: " + err.message;
              this.loading = false;
            }
          },

          // Map WMO weather code to condition
          mapWeatherCode(code) {
            const mapping = {
              0: { text: "Clear Sky", icon: "sun", theme: "clear" },
              1: {
                text: "Mainly Clear",
                icon: "sun-cloud",
                theme: "partly-cloudy",
              },
              2: {
                text: "Partly Cloudy",
                icon: "cloud-sun",
                theme: "partly-cloudy",
              },
              3: { text: "Overcast", icon: "cloud", theme: "overcast" },
              45: { text: "Fog", icon: "cloud", theme: "overcast" },
              48: { text: "Fog", icon: "cloud", theme: "overcast" },
              51: { text: "Light Drizzle", icon: "rain", theme: "rain" },
              53: { text: "Drizzle", icon: "rain", theme: "rain" },
              55: { text: "Heavy Drizzle", icon: "rain", theme: "rain" },
              56: { text: "Freezing Drizzle", icon: "rain", theme: "rain" },
              57: { text: "Freezing Drizzle", icon: "rain", theme: "rain" },
              61: { text: "Light Rain", icon: "rain", theme: "rain" },
              63: { text: "Rain", icon: "rain", theme: "rain" },
              65: { text: "Heavy Rain", icon: "rain", theme: "rain" },
              66: { text: "Freezing Rain", icon: "rain", theme: "rain" },
              67: { text: "Freezing Rain", icon: "rain", theme: "rain" },
              71: { text: "Light Snow", icon: "snow", theme: "snow" },
              73: { text: "Snow", icon: "snow", theme: "snow" },
              75: { text: "Heavy Snow", icon: "snow", theme: "snow" },
              77: { text: "Snow Grains", icon: "snow", theme: "snow" },
              80: { text: "Light Showers", icon: "rain", theme: "rain" },
              81: { text: "Showers", icon: "rain", theme: "rain" },
              82: { text: "Heavy Showers", icon: "rain", theme: "rain" },
              85: { text: "Snow Showers", icon: "snow", theme: "snow" },
              86: { text: "Snow Showers", icon: "snow", theme: "snow" },
              95: {
                text: "Thunderstorm",
                icon: "lightning",
                theme: "thunderstorm",
              },
              96: {
                text: "Thunderstorm",
                icon: "lightning",
                theme: "thunderstorm",
              },
              99: {
                text: "Thunderstorm",
                icon: "lightning",
                theme: "thunderstorm",
              },
            };

            return (
              mapping[code] || {
                text: "Unknown",
                icon: "cloud",
                theme: "partly-cloudy",
              }
            );
          },

          // Update background based on weather
          updateBackground(code) {
            const theme = this.mapWeatherCode(code).theme;
            const themes = {
              clear:
                "bg-gradient-to-br from-blue-400 via-blue-500 to-orange-400",
              "partly-cloudy": "bg-gradient-to-br from-sky-400 to-gray-300",
              overcast: "bg-gradient-to-br from-gray-400 to-slate-600",
              rain: "bg-gradient-to-br from-slate-500 to-blue-gray-600",
              snow: "bg-gradient-to-br from-blue-200 to-white",
              thunderstorm: "bg-gradient-to-br from-gray-700 to-gray-900",
            };

            this.bgClass = themes[theme] || themes["clear"];
          },

          // Get weather icon SVG
          getWeatherIcon(code) {
            const iconType = this.mapWeatherCode(code).icon;

            const icons = {
              sun: `<svg class="animate-spin-slow w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="20" fill="#FDB813"/>
                            <line x1="50" y1="10" x2="50" y2="20" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="50" y1="80" x2="50" y2="90" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="10" y1="50" x2="20" y2="50" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="80" y1="50" x2="90" y2="50" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="21" y1="21" x2="28" y2="28" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="72" y1="72" x2="79" y2="79" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="79" y1="21" x2="72" y2="28" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                            <line x1="28" y1="72" x2="21" y2="79" stroke="#FDB813" stroke-width="3" stroke-linecap="round"/>
                        </svg>`,

              "sun-cloud": `<svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="35" cy="35" r="12" fill="#FDB813" class="animate-spin-slow" style="transform-origin: 35px 35px;"/>
                            <ellipse cx="65" cy="60" rx="25" ry="18" fill="white" class="animate-float"/>
                            <ellipse cx="50" cy="55" rx="20" ry="15" fill="white" class="animate-float"/>
                        </svg>`,

              "cloud-sun": `<svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="55" cy="50" rx="28" ry="20" fill="white" class="animate-float"/>
                            <ellipse cx="40" cy="48" rx="22" ry="18" fill="white" class="animate-float"/>
                            <ellipse cx="70" cy="52" rx="20" ry="16" fill="white" class="animate-float"/>
                        </svg>`,

              cloud: `<svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="45" rx="30" ry="22" fill="#E5E7EB" class="animate-float"/>
                            <ellipse cx="35" cy="50" rx="25" ry="20" fill="#E5E7EB" class="animate-float"/>
                            <ellipse cx="65" cy="50" rx="25" ry="20" fill="#E5E7EB" class="animate-float"/>
                        </svg>`,

              rain: `<svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="35" rx="28" ry="20" fill="#9CA3AF"/>
                            <ellipse cx="35" cy="38" rx="22" ry="18" fill="#9CA3AF"/>
                            <line x1="35" y1="55" x2="35" y2="75" stroke="#4B5563" stroke-width="2" class="animate-fall"/>
                            <line x1="50" y1="55" x2="50" y2="75" stroke="#4B5563" stroke-width="2" class="animate-fall" style="animation-delay: 0.3s;"/>
                            <line x1="65" y1="55" x2="65" y2="75" stroke="#4B5563" stroke-width="2" class="animate-fall" style="animation-delay: 0.6s;"/>
                        </svg>`,

              snow: `<svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="35" rx="28" ry="20" fill="#D1D5DB"/>
                            <text x="35" y="70" font-size="16" fill="#3B82F6" class="animate-fall-slow">❄</text>
                            <text x="50" y="70" font-size="16" fill="#3B82F6" class="animate-fall-slow" style="animation-delay: 0.5s;">❄</text>
                            <text x="65" y="70" font-size="16" fill="#3B82F6" class="animate-fall-slow" style="animation-delay: 1s;">❄</text>
                        </svg>`,

              lightning: `<svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="35" rx="30" ry="22" fill="#374151"/>
                            <polygon points="50,50 45,65 52,65 48,80 58,60 52,60 56,50" fill="#FCD34D"/>
                        </svg>`,
            };

            return icons[iconType] || icons["cloud"];
          },

          // Display temperature with unit
          displayTemp(celsius) {
            if (celsius === null || celsius === undefined) return "N/A";
            const temp =
              this.units === "imperial" ? (celsius * 9) / 5 + 32 : celsius;
            const unit = this.units === "imperial" ? "°F" : "°C";
            return Math.round(temp) + unit;
          },

          // Display wind speed with unit
          displayWindSpeed(kmh) {
            if (kmh === null || kmh === undefined) return "N/A";
            const speed = this.units === "imperial" ? kmh * 0.621371 : kmh;
            const unit = this.units === "imperial" ? " mph" : " km/h";
            return Math.round(speed) + unit;
          },

          // Format date to day name
          formatDay(dateString) {
            const date = new Date(dateString);
            const today = new Date();

            // Check if it's today
            if (date.toDateString() === today.toDateString()) {
              return "Today";
            }

            return date.toLocaleDateString("en-US", { weekday: "short" });
          },
        };
      }
    </script>
  </body>
</html>
